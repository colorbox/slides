
## アジャイルから
## ウォーターフォールへ
## そして...

Kaigi on Rails 2023 (非公式) 前夜祭

@color_box

2023/10/25

---

## 自己紹介

永和システムマネジメント
アジャイル事業部

Twitter: @color_box
GitHub:  @colorbox

---

アジャイルプロジェクトで
ウォーターフォールみたいな
仕様書を要求された話

```note
さっそく今日話すことなんですけど
アジャイルプロジェクトで働いているときに、いきなりウォーターフォールプロジェクトみたいな
仕様書を要求されたらみなさんどうしますか？
今回は私が働いているプロジェトで実際に起った話とその対応について話していこうと思います。
```

---

## プロジェクト紹介

約10年アジャイルでやっているプロジェクト


```note
まず私の働いているプロジェクトについての紹介なんですが
だいたい10年くらい続いているプロジェクトです。
初期から弊社が関わっています。
```

---

## 地殻変動

リプレース

```note
大きな変化がありまして
作り直し、いわゆるリプレースってやつが始まりました、
```

---

リプレース
されど
現行プロジェクトを部分的再利用

```note
リプレースプロジェクトは現行プロダクトを全面的に作り直すプロジェクトなんですが
現行プロジェクトを一部再利用して、その分作業量を減らそうという方針が最初に設定されていました。

そういうわけで現行プロジェクトとリプレースプロジェクトが協調して動くという状況になったわけですね
```

---

## ウォーターフォールへ？

- リプレースはウォーターフォール
- 現行はアジャイルによるDevOps

```note
そして、リプレースプロジェクトはウォーターフォールとして進め
現行プロジェクトはアジャイルで、従来と変わらない方式で進めるということになりました。

ある日突然アジャイルプロジェクトがウォーターフォールになるという事態にはならなかったわけです
```

---

ウォーターフォール + アジャイル

```note
そんなわけで、体外的には単一プロダクトを扱うプロジェクトの中で
リプレースプロジェクトと現行プロジェクトという2つのプロジェクトが並走し
なおかつそれらのスタイルが異なっているという。
ウォーターフォールとアジャイルが共存するという状況になったわけです
```
---

## 要仕様書

- リプレースのために仕様把握が必要
- そのための仕様書が求められた

```note
リプレースプロジェクトを進めるにあたり
現行プロジェクトの仕様を把握する必要が出てきました

リプレースなので当然現行プロダクトの仕様が必要になります。
```

---

## 仕様書はない

動作しない中間成果物は作らない

```note
ただ、ここで問題がありまして、それは何かというと
現行プロジェクトでは、仕様書は作らない方針だったのでした。

いわゆる動作しない中間成果物というのは作らないとしていました
動作するもの、実行されるものであれば、自動テストによる確認で常にその状態を確認できるのでよいのですが
情報が書かれただけの仕様書というのはいずれ保守されなくなって内容が最新の状況を反映しなくなり、役に立たなくなってしまいます
また、ドキュメントを維持管理しようとすると、コードと仕様書とで二重管理になってしまいコストが余分にかかります。

そういった事情からただ情報が書かれただけの仕様書は基本作らないという方針にしていました
```

---

<img src="../manifest_with_doc.png" alt="manifest Image" style="width: 1000px; "/>

```note
つまりこれなんですよ
アジャイルマニフェストにもある通り、包括的なドキュメントよりも動くソフトウェアを、という方針を尊重していたわけです。
```

---

## これまでのやり方

- 仕様書は不要だった
- メンバは時間をかけて仕様を把握する
- 短時間で全仕様を把握する必要はない

```note
そんなわけでこれまでまとまった仕様書は不要だったんですよね

たとえば新メンバが加入したときとかは
調査や実装を通して仕様を徐々に把握してもらっていくというスタイルでやっていました。
徐々にチームの平均的は仕様把握に近づいていくというやり方です

そんなわけで基本的にプロジェクトの全仕様を短時間で一気に把握しなくてはいけないという状況が存在しなかったんです
```

---

仕様把握のための資料を求められた

```note
とはいえ今回のリプレース案件で現プロジェクトの全仕様を把握する必要があります
そういった事情から仕様書はないかと要求されたわけですね
```

---


<img src="../manifest_with_doc.png" alt="Example Image" style="width: 1000px; "/>

```note
いわゆる包括的なドキュメントってやつです
```


---

## 人力対応

最初は人力対応

---

すぐ限界

---

ないのは作る
ただし自動で

---

E2Eテストから仕様書的なものを抽出する

---

## 作ったgem

siyousho(仕様書)

https://rubygems.org/gems/siyousho

<img src="../rubygems_siyousho.png" alt="Example Image" style="width: 1000px; "/>

```note
gem名は仕様書、です。
お仕事プロジェクト向けにRSpecのfeature spec向けに作っていたのですが
流石に現代的にfeature specは古そうということで
System testで動くようにしています。
```

---

## 機能紹介

- gem 'siyousho'
- system testを実行
- 仕様書(補助資料)が完成

```note
gemの紹介なのですが

機能としてはごくごく単純で
このgemを入れてsystem testを実行するだけで
仕様書っぽいものを全自動で生成できます。
```

---

実際に生成したものを見せる

---

## 仕組み

- RSpecのstep hook(ぽいもの)をモンキーパッチで実現
- テスト実行時にテストコードを動的書き換え

- method_source gemでテストコード位置特定
- parserで編集、行単位でコード挿入



```note
仕組み自体はシンプルです。
単純にsystem testの各行のコードと行実行後のブラウザのスクショを保存して、それをHTMLに吐いて並べるだけです
最初のバージョンはRSpecのfeature spec向けに作っていました
feature specにはstep hookというものがありまして、ざっくりいうとfeature specの各業の前後で実行するコードを記述できるというものです。
minitestにおけるsetupとteardownを行単位でできる感じですね

system testには同様の仕組みがないのでそこも含めて再現することにしました。

minitestにモンキーパッチをあててむりやり各業の実行後にスクショ撮影と行の文字列保存をしています。
テストを表現するブロックコードをバラバラにして、情報抽出のコードを挿入して戻すって感じですね。

もう少し改善の余地はあるかと思いますが一旦はそんな仕組みで動かしています。
```

---

テストに込められた情報を
非エンジニアでも読み取り可能に出力

```note
これって何をやっているかと言うと
テストの中で検証されている仕様をHTMLにして、非エンジニアでもある程度見れるように抽出してわけですね
もちろん各ステップの情報はエンジニアでないと読み取れないものなのですが
スクリーンショットを各ステップごとに追記しているのでおおむねどんな動きをしているか、させているかというのはわかるかと思います。
実際にアプリを動かさずとも、テストで確認したい項目 仕様を確認するために動かしているテストがどのような動きをしているかをHTMLに出力したんですね
仕様理解の補助資料を自動作成したってわけですね

例えばプロジェクトの新しく入った方、特に非エンジニアの方への仕様説明資料などにも活用可能というわけですね
もちろんエンジニアの人でも、テストの挙動をざっくりと確認したいといったときにも使えそうです
```

---

テストの持つ情報を活用するには
丁寧なテストコードが必要


```note
いちばん大事な点としては、先程お見せした出力したものっていうのはテストを変換したものに過ぎないんですよね
いくらテストを見やすくしたといっても、そのテストそのものがよくわからん感じになっていると出力されたもののぼんやりしたものになってしまうんですよ
例えば一つのテストで複数に仕様を確認しているとか、テストのタイトルが何を確認したいのかよくわからんとか
そういうテストを変換してもあんま意味ないって感じです

テストは情報資産として活用可能なんですが、ある程度わかりやすく書かないと活用しづらいという話なんでうsね
```

---

## わかりやすい
## テストコードとは？

- 仕様を反映している
- 1つのテストで1つの仕様を確認する
- タイトルがわかりやすい

```note
じゃあわかりやすいテストコードって具体的に何やねんというはなしなんですが
例えば私はこういうコードであれば、読みやすいと感じます。
```

---

## オチ

```note
まず初めに言うと、さっきのgemとそれによって生成された仕様書は
結局仕事で活用されることはありませんでした。
```

---

## アジャイルから
## ウォーターフォールへ
## そして


```note
突然なのですが
最初に話した発表タイトルは不完全なものだったので
完全なタイトルを発表させていただきます。
最初にお見せした発表のタイトルは
「アジャイルからウォーターフォールへ、そして」
でした
```

---

## アジャイルから
## ウォーターフォールへ
## そして
# メテオフォール


```note
正式名称は
アジャイルからウォーターフォールへ
そしてメテオフォール
というタイトルでした。
```

---

## メテオフォール

- 上層部の判断による大幅な方針変換
- 生成した仕様書が不要に

```note
だいたい何が起きたか感づいた方もいるかと思うのですが
プロジェクトの大幅な方針変換が行われたわけです
メテオフォールというやつですね

一番最初にプロジェクトのリプレース案件に伴って、仕様書だのが必要になったという話をしたかと思います。
現行プロジェクトを一部再利用するため、その仕様書が必要になるというこちでした
しあｋし、この方針変更で現行プロジェクトを再利用するという話が全部消えてしまいました
今回作成した仕様書が使われることはきれいさっぱりなくなってしまったわけです。

残ったのは作ったgemだけというわけですね
```

---

## まとめ

- テストの中の情報を活用する
- そのために丁寧なテストが必要
- E2Eテスト名はとても大事


```note
はいまとめです


今回は
マンパワーではなく技術で解決しようね、といった話や
テスト、特にE2Eテストに書かれた情報を活用して仕様の補助資料を作る、という話をさせていただきました。

一番伝えたいこととしましては、テストを丁寧に書くことの重要性ですね
テストを仕様の確認をするように記述することで、仕様書の近似的な存在にできます。
そのように丁寧に書いたテストはプロジェクトの情報資源として活用可能になります。

なので、E2Eテストは丁寧に書きましょう！

発表は以上となります。

今日お話した内容がどなたかのお役に立てば幸いです。

ありがとうございました。
```

---
